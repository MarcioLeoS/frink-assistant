services:
  mysql:
    image: mysql:8.4
    container_name: mysql_frink
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --log-bin-trust-function-creators=ON
      - --max_connections=200
      - --max_allowed_packet=64M
    volumes:
      - mysql_data:/var/lib/mysql
      - ./infrastructure/mysql/seed:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 20
    security_opt:
      - no-new-privileges:true
    # SEGURIDAD: Puerto MySQL no expuesto
    # ports:
    #   - "3306:3306"

  n8n:
    image: n8nio/n8n:latest
    container_name: n8n_frink
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      TZ: ${TZ}
      WEBHOOK_URL: "http://localhost:${N8N_PORT}"
      DB_TYPE: mysqldb
      DB_MYSQLDB_HOST: mysql
      DB_MYSQLDB_PORT: 3306
      DB_MYSQLDB_DATABASE: ${MYSQL_DATABASE}
      DB_MYSQLDB_USER: ${MYSQL_USER}
      DB_MYSQLDB_PASSWORD: ${MYSQL_PASSWORD}
      N8N_HOST: "0.0.0.0"
      N8N_PORT: 5678
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: "true"
      # Seguridad adicional n8n
      N8N_BLOCK_ENV_ACCESS_IN_NODE: "true"
      N8N_SECURE_COOKIE: "false"  # Cambiar a true en producción con HTTPS
    ports:
      - "${N8N_PORT}:5678"
    volumes:
      - n8n_data:/home/node/.n8n
    security_opt:
      - no-new-privileges:true

  phpmyadmin:
    image: phpmyadmin:latest
    container_name: pma_frink
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_ABSOLUTE_URI: "http://localhost:${PMA_PORT}/"
      PMA_BLOWFISH_SECRET: ${PMA_BLOWFISH}
      UPLOAD_LIMIT: 128M
      MAX_EXECUTION_TIME: 300
      MEMORY_LIMIT: 256M
      PMA_HIDE_DB: "^(information_schema|performance_schema|mysql|sys)$"
    # NO exponemos directamente, usamos nginx
    expose:
      - "80"
    volumes:
      - ./infrastructure/phpmyadmin/config.user.inc.php:/etc/phpmyadmin/config.user.inc.php:ro
    security_opt:
      - no-new-privileges:true

  # Nginx con autenticación HTTP básica (seguridad para producción)
  nginx-pma:
    image: nginx:alpine
    container_name: nginx_pma_frink
    restart: unless-stopped
    depends_on:
      - phpmyadmin
    ports:
      - "${PMA_PORT}:80"
    volumes:
      - ./infrastructure/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./infrastructure/nginx/.htpasswd:/etc/nginx/.htpasswd:ro
    environment:
      - NGINX_HOST=localhost
      - NGINX_PORT=80
    security_opt:
      - no-new-privileges:true

  # Auto-updates de contenedores
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower_frink
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      WATCHTOWER_CLEANUP: "true"
      WATCHTOWER_POLL_INTERVAL: 86400
      WATCHTOWER_INCLUDE_STOPPED: "false"
      WATCHTOWER_REVIVE_STOPPED: "false"
      WATCHTOWER_NO_PULL: "false"
    security_opt:
      - no-new-privileges:true

  # Backup automático de MySQL
  backup:
    image: fradelg/mysql-cron-backup
    container_name: mysql_backup_frink
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASS: ${MYSQL_ROOT_PASSWORD}
      MAX_BACKUPS: 14
      INIT_BACKUP: 1
      CRON_TIME: "0 2 * * *"
      GZIP_LEVEL: 9
      TIMEOUT: 10m
    volumes:
      - ./infrastructure/backups:/backup
    security_opt:
      - no-new-privileges:true

  # Laravel Application (Frink Assistant Web)
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: frink_web
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      # Laravel Database Config
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${FRINK_DB}
      DB_USERNAME: ${FRINK_DB_USER}
      DB_PASSWORD: ${FRINK_DB_PASSWORD}
      # Laravel Config
      APP_NAME: "Frink Assistant"
      APP_ENV: production
      APP_KEY: ${LARAVEL_APP_KEY}
      APP_DEBUG: "false"
      APP_URL: http://localhost:${WEB_PORT:-8000}
      # Sessions, Cache, Queue
      SESSION_DRIVER: database
      CACHE_STORE: database
      QUEUE_CONNECTION: database
      # Mail
      MAIL_MAILER: log
      # MercadoPago
      MP_PUBLIC_KEY: ${MP_PUBLIC_KEY:-}
      MP_ACCESS_TOKEN: ${MP_ACCESS_TOKEN:-}
      PAYMENT_VALIDATION: ${PAYMENT_VALIDATION:-false}
    ports:
      - "${WEB_PORT:-8000}:80"
    volumes:
      - ./web/storage:/var/www/html/storage
      - ./web/bootstrap/cache:/var/www/html/bootstrap/cache
    security_opt:
      - no-new-privileges:true

volumes:
  mysql_data:
  n8n_data:
